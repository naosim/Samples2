<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>タスクかんばん</title>
<meta name="Keywords"  content="JavaScript,HTML5,CSS" />

<!-- CSS -->
<style type="text/css">
* {
	padding-top:0px;
	margin:0px;
}
body {
    color: rgba(0,0,0,0.5);
    background: -moz-linear-gradient(top, #000, #222);  
    background: -webkit-gradient(linear, left top, left bottom, from(#000), to(#222));
    font: 20px sans-serif;
}
.header {
	padding: 4px;
	padding-top:20px;
	width: 100%;
	color: #EEE;
	background-color: rgba(0,0,0,0.5);
	position: fixed;
	z-index:10;
}
.headerMargin {
	height: 80px;
}
.baseTable {
	border-collapse:collapse;
	display: -webkit-box;
  	display: -moz-box;
 	width: 90%;
 	list-style: none;

}
.tableHeader {
	height: 32px;
	padding:4px;
	color: #FFF;
}
.taskTable {
	border-top-color: rgba(0,0,0,0.3);
	border-bottom-color: rgba(1.0,1.0,1.0,0.7);
	border-top-width: 2px;
	border-spacing: 0px;
	border-style: solid;
	width: 33%;
	padding:0px;
	list-style: none;
}

.task {
	color: #333;
	font: 18px sans-serif;
    width: 98%;
    min-height: 48px;
    padding: 2%;
    
    /*background: #f1f3a2;*/
    -webkit-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -o-transform: rotate(0deg);
	float:left;
	cursor: move;
	display: inline;
}

#profile {
	position:fixed;
	width:300px;
	height:300px;
	left:64px;
	top:64px;
	background-color:#EEE;
	border-radius: 10px;
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	font-size: 12px;
	padding: 8px;
}
#popup {
	position:fixed;
	left:0px;
	top:0px;
	z-index:99;
	padding:0px;
	margin:0px;
	width:100%;
	height:100%;
	background-color: rgba(0,0,0,0.5);
	display: none;
}
#infoLink {
	width:64px;
	margin: 12px;
	color:#F58;
	font-size: 14px;
	cursor: pointer;
}
.deleteButton {
	position:absolute;
	right:8px;
	bottom:0px;
	width:26px;
	cursor: pointer;
}
#addTaskBox {
	padding: 4px;
	font-size: 18pt;
}

.close {
	position:absolute;
	right:8px;
	bottom:8px;
	width:58px;
	cursor: pointer;
}


</style></head>
<body>
<!-- HTML -->
<div class="header">タスクかんばん <span style="font-size: 11pt">ver0.1</span>   タスク追加：<input id="addTaskBox" type="text" /><!--<button onclick="pressedAddButton()" width="44px">add</button>--></div>
<div class="headerMargin"></div>
<!--
<table width="100%" border="1px" class="baseTable">
	<tr class="tableHeader"><th width="30%">TODO</th><th width="30%">DOING</th><th width="30%">DONE</th></tr>
	<tr>
		<td id="todoTable" class="taskTable"></td>
		<td id="doingTable" class="taskTable"></td>
		<td id="doneTable" class="taskTable"></td>
	</tr>
</table>
-->
<ul class="baseTable">
  <li id="todoTable" class="taskTable"><div class="tableHeader">TODO</div></li>
  <li id="doingTable" class="taskTable"><div class="tableHeader">DOING</div></li>
  <li id="doneTable" class="taskTable"><div class="tableHeader">DONE</div></li>
</ul>

<!--shinobi1-->
<script type="text/javascript" src="http://x8.ninpou.jp/ufo/141201204"></script>
<noscript><a href="http://x8.ninpou.jp/bin/gg?141201204" target="_blank">
<img src="http://x8.ninpou.jp/bin/ll?141201204" border="0"></a><br>
<span style="font-size:9px"><img style="margin:0;vertical-align:text-bottom;" src="http://img.shinobi.jp/tadaima/fj.gif" width="19" height="11"> <a href="http://credit_card.rentalurl.net/" target="_blank">キャッシング</a></span></noscript>
<!--shinobi2-->
<div id="infoLink" onclick="info();">作者情報</div>
<div id="popup">
<div id="profile">
■作者情報<br>
name : ナオシム<br>
twitter : @naosim_<br> 
blog : <a href="http://naosim.blog16.fc2.com/" target="_blank">http://naosim.blog16.fc2.com/</a><br>
PR : <br>
Developping iPhone Application and Web Site in Niigata Japan.<br>
I was born in 1982.<br>
The pillows fan.<br>
<div class="close" onclick="info();">[x 閉じる]</div>
</div>
</div>
<!-- javascript -->
<script type="text/javascript">

////// モデル ///////

/**
 * テーブルの内容を管理するオブジェクト
 * それぞれの配列にタスクIDを持つ
 */
var tableData = {
	todos:new Array(),
	doings:new Array(),
	dones:new Array()
};
/**
 * タスク
 * id, name, todoDate, doingDate, doneDate, state
 */
var tasks = new Array();
/**
 * DBからテーブルデータをロードする
 */
var loadData = function() {
	var str = localStorage.tableData;
	if(str) {
		tableData = JSON.parse(str);
	}
};
/**
 * DBへテーブルデータをセーブする
 */
var saveData = function() {
	localStorage.tableData = JSON.stringify(tableData);
};

var loadTask = function() {
	
};

var removeTask = function(task) {
	var oldData = tableData;
	tableData = {
		todos:new Array(),
		doings:new Array(),
		dones:new Array()
	};
	for(var key in oldData) {
		var tableId = dataKeyToTableId(key);
		for(var i = 0; i < oldData[key].length; i++) {
			var t = oldData[key][i];
			if(t.id != task.id) {
				tableData[key].push(t);
			}
		}
	}
};

/**
 * タスクを追加する
 * DOMからタスク名を抽出して、新しいタスクを生成する
 * DOMのエディットモードを終了する
 */
var addTaskToTable = function(task, tableId) {
	var elm = createTaskElm(task);
	document.getElementById(tableId).appendChild(elm);
};


var tableIdToDataKey = function(tableId) {
	if(tableId == 'todoTable') {
		key = 'todos';
	}
	else if(tableId == 'doingTable') {
		key = 'doings';
	}
	else if(tableId == 'doneTable') {
		key = 'dones';
	}
	return key;
};

var dataKeyToTableId = function(key) {
	var tableId;
	if(key == 'todos') {
		tableId = 'todoTable';
	}
	else if(key == 'doings') {
		tableId = 'doingTable';
	}
	else if(key == 'dones') {
		tableId = 'doneTable';
	}
	return tableId;
};

var createTaskElm = function(task) {	
	var elm = document.createElement('div');
	elm.className = 'task';
	elm.draggable = 'true';
	elm.addEventListener('dragstart', f_dragstart);
	elm.id = task.id;
	elm.task = task;
	
	var p = document.createElement('p');
	p.innerHTML = task.name;
	elm.appendChild(p);
	
	var deleteButton = document.createElement('div');
	deleteButton.className = 'deleteButton';
	deleteButton.innerHTML = '<img src="img/trash_icon24.png" />';
	deleteButton.addEventListener('click', pressedDeleteButton);
	elm.addEventListener('mouseover', onMouse);
	elm.addEventListener('mouseout', outMouse);
	elm.appendChild(deleteButton);
	outMouse.call(elm);

	return elm;
};

var onMouse = function() {
	var deleteButton = this.getElementsByClassName("deleteButton")[0];
	deleteButton.style.display = "block";
}

var outMouse = function() {
	var deleteButton = this.getElementsByClassName("deleteButton")[0];
	deleteButton.style.display = "none";
}

var init = function() {
	taskTables = document.getElementsByClassName('taskTable');
	for(var i = 0; i < taskTables.length; i++) {
		taskTables[i].addEventListener('dragover', f_dragover);
		taskTables[i].addEventListener('drop', f_drop);
	}
	
	document.getElementById('addTaskBox').addEventListener('keypress', onKey);
	
	loadData();
	
	for(var key in tableData) {
		var tableId = dataKeyToTableId(key);
		for(var i = 0; i < tableData[key].length; i++) {
			var task = tableData[key][i];
			addTaskToTable(task, tableId);
		}
	}
	resetTaskColor();
};


var info = function() {
	var popup = document.getElementById('popup');
	if(popup.style.display == 'block') {
		popup.style.display = 'none';
	}
	else {
		popup.style.display = 'block';
	}
};

//// イベント ///////
var pressedDeleteButton = function() {
	var elm = this.parentElement;
	removeTask(elm.task);
	saveData();
	elm.parentElement.removeChild(elm);
	resetTaskColor();
};

/***** ドラッグ開始時の処理 *****/
function f_dragstart(event){
	//ドラッグするデータのid名をDataTransferオブジェクトにセット
	event.dataTransfer.setData("text", event.target.id);
}

/***** ドラッグ要素がドロップ要素に重なっている間の処理 *****/
function f_dragover(event){
	//dragoverイベントをキャンセルして、ドロップ先の要素がドロップを受け付けるようにする
	event.preventDefault();
}

/***** ドロップ時の処理 *****/
function f_drop(event){
	//ドラッグされたデータのid名をDataTransferオブジェクトから取得
	var id_name = event.dataTransfer.getData("text");
	//id名からドラッグされた要素を取得
	var drag_elm =document.getElementById(id_name);
	
	if(drag_elm.parentElement == event.currentTarget) {
		return;
	}
	
	//ドロップ先にドラッグされた要素を追加
	event.currentTarget.appendChild(drag_elm);
    //エラー回避のため、ドロップ処理の最後にdropイベントをキャンセルしておく
	event.preventDefault();
	
	var task = drag_elm.task;
	removeTask(task);
	
	var key = tableIdToDataKey(event.currentTarget.id);
	tableData[key].push(task);
	saveData();
	resetTaskColor();
}

var MAX_COLOR = 9;

var resetTaskColor = function() {
	var todos = document.getElementById('todoTable').childNodes;
	for(var i = 1; i < todos.length; i++) {
		var elm = todos[i];
		var p = Math.floor(i * MAX_COLOR / todos.length);
		elm.style.background = "#F" + p + "" + p;
	}
	var doings = document.getElementById('doingTable').childNodes;
	for(var i = 1; i < doings.length; i++) {
		var elm = doings[i];
		var p = Math.floor(i * MAX_COLOR / doings.length);
		elm.style.background = "#FF" + p;
	}
	var dones = document.getElementById('doneTable').childNodes;
	for(var i = 1; i < dones.length; i++) {
		var elm = dones[i];
		var p = Math.floor(i * MAX_COLOR / dones.length);
		elm.style.background = "#" + p + "F" + p;
	}
}

var onKey = function(e){
	if(e.keyCode == 13) {
		pressedAddButton();
	}
};

/**
 * タスク追加ボタンが押された
 * DOMに新しいタスク領域を追加する
 * タスク領域はエディットモードにする
 */
var pressedAddButton = function() {
	
	if(document.getElementById('addTaskBox').value.length == 0) {
		return;
	}
	
	var task = {
		id:new Date().getTime(),
		name:document.getElementById('addTaskBox').value,
		state:0,
		todoDate:new Date().getTime(),
		doingDate:-1,
		doneDate:-1
	};
	addTaskToTable(task, 'todoTable');
	tableData.todos.push(task);
	
	document.getElementById('addTaskBox').value = '';
	
	saveData();
	resetTaskColor();
};


init();
</script>
</body>
</html>
