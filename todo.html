<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" /><title></title>
<meta name="Keywords"  content="JavaScript,HTML5,CSS" />

<!-- CSS -->
<style type="text/css">
body {
    Color: #ffffff;
    background-color: #323232;
    font: 30px sans-serif;
}
.taskTable {
}
.task {
	margin:2px;
	width: 90%;
	font-size:18pt;
	background-color:#035;
	cursor: move;
}
.deleteButton {
	cursor: pointer;
}
#addTaskBox {
	padding: 8px;
	font-size: 18pt;
}
</style></head>
<body>
<!-- HTML -->
<div>タスクかんばん</div>
<table width="100%" border="1px">
	<tr><th width="30%">TODO</th><th width="30%">DOING</th><th width="30%">DONE</th></tr>
	<tr>
		<td id="todoTable" class="taskTable"></td>
		<td id="doingTable" class="taskTable"></td>
		<td id="doneTable" class="taskTable"></td>
	</tr>
</table>
<input id="addTaskBox" type="text" />
<!-- javascript -->
<script type="text/javascript">
/**
 * テーブルの内容を管理するオブジェクト
 * それぞれの配列にタスクIDを持つ
 */
var tableData = {
	todos:new Array(),
	doings:new Array(),
	dones:new Array()
};
/**
 * タスク
 * id, name, todoDate, doingDate, doneDate, state
 */
var tasks = new Array();
/**
 * DBからテーブルデータをロードする
 */
var loadData = function() {
	var str = localStorage.tableData;
	if(str) {
		tableData = JSON.parse(str);
	}
};
/**
 * DBへテーブルデータをセーブする
 */
var saveData = function() {
	localStorage.tableData = JSON.stringify(tableData);
};

var loadTask = function() {
	
};

var removeTask = function(task) {
	var oldData = tableData;
	tableData = {
		todos:new Array(),
		doings:new Array(),
		dones:new Array()
	};
	for(var key in oldData) {
		var tableId = dataKeyToTableId(key);
		for(var i = 0; i < oldData[key].length; i++) {
			var t = oldData[key][i];
			if(t.id != task.id) {
				tableData[key].push(t);
			}
		}
	}
};

/**
 * タスクを追加する
 * DOMからタスク名を抽出して、新しいタスクを生成する
 * DOMのエディットモードを終了する
 */
var addTaskToTable = function(task, tableId) {
	var elm = createTaskElm(task);
	
	document.getElementById(tableId).appendChild(elm);
};

var onKey = function(e){
	if(e.keyCode == 13) {
		pressedAddButton();
	}
};

/**
 * タスク追加ボタンが押された
 * DOMに新しいタスク領域を追加する
 * タスク領域はエディットモードにする
 */
var pressedAddButton = function() {
	var task = {
		id:new Date().getTime(),
		name:document.getElementById('addTaskBox').value,
		state:0,
		todoDate:new Date().getTime(),
		doingDate:-1,
		doneDate:-1
	};
	addTaskToTable(task, 'todoTable');
	tableData.todos.push(task);
	
	saveData();
};

var tableIdToDataKey = function(tableId) {
	if(tableId == 'todoTable') {
		key = 'todos';
	}
	else if(tableId == 'doingTable') {
		key = 'doings';
	}
	else if(tableId == 'doneTable') {
		key = 'dones';
	}
	return key;
};

var dataKeyToTableId = function(key) {
	var tableId;
	if(key == 'todos') {
		tableId = 'todoTable';
	}
	else if(key == 'doings') {
		tableId = 'doingTable';
	}
	else if(key == 'dones') {
		tableId = 'doneTable';
	}
	return tableId;
};

var createTaskElm = function(task) {
	var input = document.createElement();
	
	var elm = document.createElement('div');
	elm.className = 'task';
	elm.draggable = 'true';
	elm.addEventListener('dragstart', f_dragstart);
	elm.id = task.id;
	elm.task = task;
	
	var p = document.createElement('p');
	p.innerText = task.name;
	elm.appendChild(p);
	
	var deleteButton = document.createElement('div');
	deleteButton.className = 'deleteButton';
	deleteButton.innerHTML = '<img src="img/trash_icon24.png" />';
	deleteButton.addEventListener('click', pressedDeleteButton);
	elm.appendChild(deleteButton);

	return elm;
};

/***** ドラッグ開始時の処理 *****/
function f_dragstart(event){
	//ドラッグするデータのid名をDataTransferオブジェクトにセット
	event.dataTransfer.setData("text", event.target.id);
}

/***** ドラッグ要素がドロップ要素に重なっている間の処理 *****/
function f_dragover(event){
	//dragoverイベントをキャンセルして、ドロップ先の要素がドロップを受け付けるようにする
	event.preventDefault();
}

/***** ドロップ時の処理 *****/
function f_drop(event){
	//ドラッグされたデータのid名をDataTransferオブジェクトから取得
	var id_name = event.dataTransfer.getData("text");
	//id名からドラッグされた要素を取得
	var drag_elm =document.getElementById(id_name);
	
	if(drag_elm.parentElement == event.currentTarget) {
		return;
	}
	
	//ドロップ先にドラッグされた要素を追加
	event.currentTarget.appendChild(drag_elm);
    //エラー回避のため、ドロップ処理の最後にdropイベントをキャンセルしておく
	event.preventDefault();
	
	var task = drag_elm.task;
	removeTask(task);
	
	var key = tableIdToDataKey(event.currentTarget.id);
	tableData[key].push(task);
	saveData();
}

var onload = function() {
	taskTables = document.getElementsByClassName('taskTable');
	for(var i = 0; i < taskTables.length; i++) {
		taskTables[i].addEventListener('dragover', f_dragover);
		taskTables[i].addEventListener('drop', f_drop);
	}
	
	document.getElementById('addTaskBox').addEventListener('keypress', onKey);
	
	loadData();
	
	for(var key in tableData) {
		var tableId = dataKeyToTableId(key);
		for(var i = 0; i < tableData[key].length; i++) {
			var task = tableData[key][i];
			addTaskToTable(task, tableId);
		}
	}
};

var pressedDeleteButton = function() {
	var elm = this.parentElement;
	removeTask(elm.task);
	saveData();
	
	elm.parentElement.removeChild(elm);
};

</script>
</body>
</html>
